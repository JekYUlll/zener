https://zhuanlan.zhihu.com/p/703329903


在非阻塞网络编程中，如何设计并使用缓冲区？  
1. 一方面我们希望减少系统调用，一次读的数据越多越划算，那么似乎应该准备一个大的缓冲区。
2. 另一方面，我们系统减少内存占用。如果有10k个连接，每个连接一建立就分配64k的读缓冲的话，将占用640M内存，而大多数时候这些缓冲区的使用率很低。
3. 因此读取数据的时候要尽可能读完，为了不扩大`buffer`，可以通过`extrabuf`来做第二层缓冲
4. muduo 的解决方案：将读取分散在两块区域，一块是`buffer`，一块是栈上的`extrabuf`（放置在栈上使得`extrabuf`随着`Read`的结束而释放，不会占用额外空间），当初始的小`buffer`放不下时才扩容

```txt
+-------------------+------------------+------------------+------------------+
| prependable bytes |   readed bytes   |  readable bytes  |  writable bytes  |
+-------------------+------------------+------------------+------------------+
|                   |                  |                  |                  |
0        <=       prePos      <=    readPos     <=     writerPos    <=     size
```